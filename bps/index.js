/*!
 * license: you may do whatever you want with this file, except blame the author if anything goes wrong
 * author: https://www.smwcentral.net/?p=profile&id=1686
 * smc support by randomdude999 (https://smwc.me/u/32552)
*/
const t=Symbol("wrong input file"),e=Symbol("not a BPS patch"),r=new Map([[t,"This patch is not intended for this ROM."],[e,"Not a BPS patch."]]),n=[];for(let t=0;t<256;t+=1){let e=t;for(let t=0;t<8;t+=1)e=1&e?3988292384^e>>>1:e>>>1;n[t]=e}function o(r,o){let l=0;const a=()=>o[l++];function s(){let t=0,e=0;for(;;){const r=a();if(t+=(128^r)<<e,128&r)return t;e+=7}}function c(){const t=s(),e=t>>1;return 1&t?-e:e}if(66!==a()||80!==a()||83!==a()||49!==a())throw e;if(s()!==r.length)throw t;if(function(t){let e=-1;for(let r=0;r<t.length;r+=1)e=e>>>8^n[255&(e^t[r])];return(-1^e)>>>0}(r)!==(i=o.length-12,(o[i+0]<<0|o[i+1]<<8|o[i+2]<<16|o[i+3]<<24)>>>0))throw t;var i;const f=new Uint8Array(s());let u=0;const h=s();l+=h;let y=0,b=0;for(;l<o.length-12;){const t=s(),e=1+(t>>2);switch(3&t){case 0:for(let t=0;t<e;t+=1)f[u]=r[u],u++;break;case 1:for(let t=0;t<e;t+=1)f[u++]=a();break;case 2:y+=c();for(let t=0;t<e;t+=1)f[u++]=r[y++];break;case 3:b+=c();for(let t=0;t<e;t+=1)f[u++]=f[b++]}}return f}export default function(e){const n=e.byID("rom"),l=e.byID("patch"),a=e.byID("button");a.addEventListener("click",(()=>{const s=n.files[0];if(null==s)return e.setStatus({error:"No base ROM selected."});const c=l.files[0];if(null==c)return e.setStatus({error:"No patch selected."});a.disabled=!0,Promise.all([s.arrayBuffer(),c.arrayBuffer()]).then((([n,l])=>{const a=function(e,n,l,a){try{let r;try{r=o(new Uint8Array(n),new Uint8Array(a))}catch(e){if(e!==t)throw e;{r=o(new Uint8Array(n,512),new Uint8Array(a));let t=new Uint8Array(r.length+512);t.set(new Uint8Array(n,0,512)),t.set(r,512),r=t}}return{name:`${l.name.slice(0,l.name.lastIndexOf("."))}.${e.name.split(".").pop()}`,blob:new Blob([r],{type:e.type})}}catch(t){if(r.has(t))return{error:r.get(t)};throw t}}(s,n,c,l);if(e.setStatus(a),null==a.error)return e.download(a.name,a.blob)})).catch((t=>{console.log(t),e.setStatus({error:"Internal error."})})).finally((()=>{a.disabled=!1}))}))}